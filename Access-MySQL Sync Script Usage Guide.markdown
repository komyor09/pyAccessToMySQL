# Руководство по использованию скрипта синхронизации Access-MySQL

Этот документ описывает, как настроить и использовать скрипт синхронизации данных из базы Microsoft Access в MySQL, а также как преобразовать его в исполняемый файл (.exe) для удобного запуска на Windows без необходимости установки Python.

## Описание скрипта

Скрипт `main.py` выполняет синхронизацию данных из таблицы базы данных Microsoft Access в таблицу MySQL. Он периодически проверяет новые записи в Access и переносит их в MySQL, сохраняя логи операций в файл.

### Основные функции:
- Проверка наличия таблицы `access_logs` в MySQL и создание её при необходимости.
- Проверка и добавление необходимых столбцов в таблицу MySQL на основе маппинга полей.
- Извлечение новых записей из Access (на основе `f_RecID`) и вставка их в MySQL.
- Обработка ошибок подключения и логирование всех операций.

## Требования

Для работы скрипта необходимы:
1. **Операционная система**: Windows (для Access ODBC-драйвера).
2. **Microsoft Access Driver**: Установленный драйвер ODBC для Access (*.mdb, *.accdb). Обычно он присутствует в Windows, но может потребоваться установка (см. раздел "Установка драйвера").
3. **MySQL сервер**: Доступный сервер MySQL с созданной базой данных.
4. **Python** (для разработки или запуска скрипта):
   - Версия: Python 3.8 или выше.
   - Библиотеки: `pyodbc`, `pymysql`, `python-dotenv`.
5. **Файл конфигурации** `.env` с параметрами подключения.

## Установка

### 1. Установка Python и зависимостей
1. Установите Python с официального сайта: https://www.python.org/downloads/.
2. Убедитесь, что Python добавлен в переменную PATH (выберите эту опцию при установке).
3. Установите необходимые библиотеки, выполнив команду в командной строке:
   ```bash
   pip install pyodbc pymysql python-dotenv
   ```

### 2. Установка Microsoft Access ODBC-драйвера
- Если ваша система 64-битная, убедитесь, что установлен 64-битный драйвер Microsoft Access (*.mdb, *.accdb).
- Если драйвер отсутствует, загрузите и установите Microsoft Access Database Engine:
  - Для 32-бит: https://www.microsoft.com/en-us/download/details.aspx?id=13255
  - Для 64-бит: https://www.microsoft.com/en-us/download/details.aspx?id=54920
- Убедитесь, что драйвер отображается в ODBC Data Source Administrator (Панель управления → Администрирование → Источники данных ODBC).

### 3. Настройка конфигурации
1. Создайте файл `.env` в той же папке, где находится `main.py`. Пример содержимого файла `.env`:
   ```ini
   # Пример файла .env для скрипта синхронизации Access-MySQL
   # Комментарии начинаются с символа # (решётка) — строки с # игнорируются при чтении .env

   # Путь к файлу базы данных Access (.mdb или .accdb)
   ACCESS_FILE_PATH=C:\path\to\file\your_database.mdb
   # Пароль для базы Access (если нет пароля, оставить пустым)
   ACCESS_DB_PASSWORD=
   # Имя таблицы в Access, из которой будут извлекаться данные
   ACCESS_TABLE_NAME=t_d_SwipeRecord

   # Параметры подключения к MySQL
   MYSQL_HOST=127.0.0.1           # Адрес сервера MySQL
   MYSQL_PORT=3306                # Порт MySQL (обычно 3306)
   MYSQL_USER=komyor              # Имя пользователя MySQL
   MYSQL_PASS=12345678            # Пароль пользователя MySQL
   MYSQL_DB=access_logs_db        # Имя базы данных MySQL
   MYSQL_TABLE_NAME=access_logs   # Имя таблицы в MySQL для синхронизации

   # Интервал опроса базы Access в секундах (например, 3600 = 1 час)
   POLL_INTERVAL=3600

   # Имя файла для логирования операций
   LOG_FILE=sync_log.log

   # Список полей для выборки из Access (указывать в виде списка через запятую, без кавычек)
   ACCESS_SELECTED_FIELDS=f_RecID,f_ConsumerID,f_CardNO,f_ReadDate,f_InOut,f_ReaderID

   # Соответствие полей Access и MySQL (указывать в виде пар через запятую: access=sql)
   FIELD_MAPPING=f_RecID=raw_id,f_ConsumerID=user_id,f_CardNO=card_id,f_InOut=in_out,f_ReadDate=read_date,f_ReaderID=reader_id
   ```
2. Измените параметры в `.env` в соответствии с вашими настройками:
   - `ACCESS_FILE_PATH`: Путь к файлу базы данных Access (.mdb или .accdb).
   - `ACCESS_DB_PASSWORD`: Пароль для базы Access (если есть).
   - `ACCESS_TABLE_NAME`: Имя таблицы в Access, из которой берутся данные.
   - `MYSQL_*`: Параметры подключения к MySQL (хост, порт, пользователь, пароль, имя базы данных, имя таблицы).
   - `POLL_INTERVAL`: Интервал опроса базы Access (в секундах).
   - `LOG_FILE`: Имя файла для логов.
   - `ACCESS_SELECTED_FIELDS`: Список полей из таблицы Access для выборки.
   - `FIELD_MAPPING`: Соответствие полей Access и MySQL.

### 4. Подготовка MySQL
1. Убедитесь, что MySQL-сервер запущен и доступен.
2. Создайте базу данных (например, `access_logs_db`):
   ```sql
   CREATE DATABASE access_logs_db;
   ```
3. Скрипт автоматически создаст таблицу `access_logs` с необходимыми столбцами при первом запуске.

## Запуск скрипта

1. Поместите файлы `main.py`, `config.py` и `.env` в одну папку.
2. Откройте командную строку в этой папке:
   - Нажмите `Shift + Правая кнопка мыши` в папке → "Открыть окно команд".
3. Выполните команду:
   ```bash
   python main.py
   ```
4. Скрипт начнёт работу, логи будут записываться в файл, указанный в `LOG_FILE` (по умолчанию `sync_log.log`).

### Остановка скрипта
- Нажмите `Ctrl+C` в командной строке для остановки.
- Скрипт автоматически переподключается к MySQL при сбоях, но при критических ошибках может потребоваться перезапуск.

## Конвертация в .exe

Чтобы запускать скрипт без Python, преобразуйте его в исполняемый файл с помощью PyInstaller.

### Требования для конвертации
- Установите PyInstaller:
  ```bash
  pip install pyinstaller
  ```

### Шаги по конвертации
1. Откройте командную строку в папке со скриптами.
2. Выполните команду для создания .exe:
   ```bash
   pyinstaller --onefile --add-data ".env;." main.py
   ```
   - `--onefile`: Создаёт один исполняемый файл.
   - `--add-data ".env;."`: Включает файл `.env` в сборку (для Windows используйте `;` как разделитель).
3. После выполнения команды:
   - Исполняемый файл появится в папке `dist` (например, `dist\main.exe`).
   - Файл `.env` должен находиться в той же папке, где запускается `main.exe`.

### Запуск .exe
1. Переместите `main.exe` и `.env` в нужную папку.
2. Дважды щёлкните по `main.exe` для запуска.
3. Логи будут записываться в файл, указанный в `LOG_FILE`.

### Примечания
- Убедитесь, что Microsoft Access ODBC-драйвер установлен на целевой машине.
- Если `.env` изменяется, обновите его в папке с `main.exe`.
- Для автоматического запуска при старте Windows:
  - Создайте ярлык для `main.exe`.
  - Поместите ярлык в папку автозагрузки: `C:\Users\<Имя_пользователя>\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup`.

## Логирование и отладка

- Логи записываются в файл, указанный в `LOG_FILE` (по умолчанию `sync_log.log`).
- Уровни логов:
  - `INFO`: Информация о создании таблицы, добавлении столбцов, вставке записей.
  - `ERROR`: Ошибки при подключении или выполнении запросов.
  - `CRITICAL`: Критические ошибки (например, невозможность подключения к MySQL).
- Просматривайте лог-файл для диагностики проблем.

## Возможные проблемы и решения

1. **Ошибка "Not a valid password"**:
   - Проверьте правильность пароля в `ACCESS_DB_PASSWORD` в `.env`.
2. **Ошибка подключения к MySQL**:
   - Убедитесь, что MySQL-сервер запущен и параметры в `.env` верны.
3. **Отсутствует драйвер ODBC**:
   - Установите Microsoft Access Database Engine (см. раздел "Установка").
4. **Поля не совпадают**:
   - Проверьте, что `ACCESS_SELECTED_FIELDS`